---
interface Props {
  startTime?: string;
  readTime?: number;
}

const { startTime, readTime } = Astro.props;
---

<div class="reading-progress" aria-hidden="true">
  <div class="reading-progress-bar" id="progress-bar" style="width: 0%"></div>
</div>

{readTime && (
  <div class="fixed bottom-6 right-6 z-40 hidden lg:block">
    <div class="bg-dark-800/90 backdrop-blur-sm border border-terminal-border rounded-lg px-4 py-2.5 shadow-lg">
      <div class="flex items-center gap-2 text-xs font-mono text-gray-400">
        <svg class="w-4 h-4 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>{readTime} min read</span>
      </div>
    </div>
  </div>
)}

<script>
  // Reading progress bar
  const progressBar = document.getElementById('progress-bar');
  
  function updateProgress() {
    const article = document.querySelector('article');
    if (!article || !progressBar) return;

    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const windowScroll = window.scrollY;

    // Calculate progress
    const start = articleTop - 100;
    const end = articleTop + articleHeight - windowHeight;
    const progress = ((windowScroll - start) / (end - start)) * 100;

    progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
  }

  // Throttle scroll events for better performance
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateProgress();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Initial call
  updateProgress();

  // Estimated reading time calculation if not provided
  const readTimeEl = document.querySelector('[data-read-time]');
  if (readTimeEl && !readTime) {
    const article = document.querySelector('article');
    if (article) {
      const text = article.textContent || '';
      const wordsPerMinute = 200;
      const wordCount = text.split(/\s+/).length;
      const calculatedReadTime = Math.ceil(wordCount / wordsPerMinute);
      readTimeEl.textContent = `${calculatedReadTime} min read`;
    }
  }
</script>
