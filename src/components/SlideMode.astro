---
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const { headings = [] } = Astro.props;

// Filter h2 and h3 headings for slides
const slideHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);
const totalSlides = slideHeadings.length + 1;
---

<!-- Slide Mode Toggle Button -->
<button
  id="slide-mode-toggle"
  type="button"
  class="fixed bottom-6 right-24 z-40 p-4 rounded-full bg-gradient-to-r from-primary-500 to-cyan-500 text-white shadow-lg hover:shadow-xl hover:scale-110 transition-all duration-300"
  aria-label="Toggle Slide Mode"
  title="Start Presentation (Press P)"
>
  <svg id="slide-mode-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
  </svg>
</button>

<!-- Slide Mode Overlay -->
<div id="slide-mode-overlay" class="hidden fixed inset-0 z-50 bg-white dark:bg-dark-900"
     data-slide-headings={JSON.stringify(slideHeadings)}
     data-total-slides={totalSlides}>
  <!-- Slide Mode Header -->
  <div class="fixed top-0 left-0 right-0 z-50 flex items-center justify-between px-6 py-4 bg-gradient-to-r from-primary-500/90 to-cyan-500/90 backdrop-blur-sm">
    <div class="flex items-center gap-4">
      <button
        id="slide-close"
        type="button"
        class="p-2 rounded-lg hover:bg-white/20 transition-colors"
        aria-label="Exit Slide Mode"
        title="Exit (Esc)"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      <div class="text-white">
        <h2 id="slide-title" class="text-lg font-semibold truncate max-w-md">Presentation Mode</h2>
        <p id="slide-progress" class="text-sm opacity-80">Slide 1 of {totalSlides}</p>
      </div>
    </div>
    
    <!-- Slide Mode Controls -->
    <div class="flex items-center gap-2">
      <!-- Drawing Mode Toggle -->
      <button
        id="drawing-mode-toggle"
        type="button"
        class="p-2 rounded-lg hover:bg-white/20 transition-colors"
        aria-label="Toggle Drawing Mode"
        title="Drawing Mode (D)"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
        </svg>
      </button>
      
      <!-- Clear Drawings -->
      <button
        id="clear-drawings"
        type="button"
        class="p-2 rounded-lg hover:bg-white/20 transition-colors"
        aria-label="Clear Drawings"
        title="Clear Drawings (C)"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      </button>
      
      <!-- Pointer Mode Toggle -->
      <button
        id="pointer-mode-toggle"
        type="button"
        class="p-2 rounded-lg hover:bg-white/20 transition-colors"
        aria-label="Toggle Pointer"
        title="Pointer Mode (L)"
      >
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122" />
        </svg>
      </button>
      
      <!-- Navigation -->
      <div class="flex items-center gap-1 ml-4 pl-4 border-l border-white/30">
        <button
          id="slide-prev"
          type="button"
          class="p-2 rounded-lg hover:bg-white/20 transition-colors"
          aria-label="Previous Slide"
          title="Previous (←/Page Up)"
        >
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <button
          id="slide-next"
          type="button"
          class="p-2 rounded-lg hover:bg-white/20 transition-colors"
          aria-label="Next Slide"
          title="Next (→/Page Down/Space)"
        >
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Slide Content Container -->
  <div id="slide-container" class="pt-24 pb-20 px-8 h-screen overflow-hidden">
    <div id="slide-content" class="max-w-5xl mx-auto h-full">
      <!-- Slides will be injected here by JavaScript -->
    </div>
  </div>
  
  <!-- Slide Navigation Dots -->
  <div id="slide-dots" class="fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-2 z-50">
    <!-- Dots will be injected here by JavaScript -->
  </div>
  
  <!-- Drawing Canvas -->
  <canvas id="drawing-canvas" class="fixed inset-0 z-40 pointer-events-none"></canvas>
</div>

<style>
  /* Slide Mode Styles */
  .slide-mode-active {
    overflow: hidden;
  }
  
  .slide-mode-active body {
    overflow: hidden;
  }
  
  /* Presentation Cursor */
  .presentation-cursor {
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233B82F6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122'/%3E%3C/svg%3E") 12 12, auto;
  }
  
  .presentation-cursor.drawing {
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23EF4444' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z'/%3E%3C/svg%3E") 12 12, auto;
  }
  
  /* Slide Transitions */
  .slide {
    display: none;
    opacity: 0;
    transform: translateX(50px);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  
  .slide.active {
    display: block;
    opacity: 1;
    transform: translateX(0);
    animation: slideIn 0.4s ease-out;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(50px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  /* Slide Content Styling */
  .slide-content-wrapper {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 1rem;
    padding: 2.5rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    height: calc(100vh - 280px);
    overflow-y: auto;
  }
  
  .dark .slide-content-wrapper {
    background: rgba(23, 23, 23, 0.95);
  }
  
  .slide-content-wrapper::-webkit-scrollbar {
    width: 8px;
  }
  
  .slide-content-wrapper::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.1);
    border-radius: 4px;
  }
  
  .slide-content-wrapper::-webkit-scrollbar-thumb {
    background: rgba(14, 165, 233, 0.5);
    border-radius: 4px;
  }
  
  .dark .slide-content-wrapper::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
  }
  
  /* Navigation Dots */
  .slide-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .slide-dot.active {
    background: white;
    transform: scale(1.3);
  }
  
  .slide-dot:hover {
    background: rgba(255, 255, 255, 0.8);
  }
  
  /* Drawing Canvas */
  #drawing-canvas {
    touch-action: none;
  }
  
  #drawing-canvas.drawing-active {
    pointer-events: auto;
  }
  
  /* Keyboard Shortcuts Help */
  .shortcuts-help {
    position: fixed;
    bottom: 100px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 1rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 100;
  }
  
  .shortcuts-help.visible {
    opacity: 1;
  }
  
  /* Slide Content Styles */
  .slide-section {
    font-size: 1.125rem;
    line-height: 1.8;
  }
  
  .slide-section h2 {
    font-size: 2rem;
    font-weight: 700;
    margin: 1.5rem 0 1rem;
    color: inherit;
  }
  
  .slide-section h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 1.25rem 0 0.75rem;
    color: inherit;
  }
  
  .slide-section p {
    margin: 1rem 0;
    line-height: 1.8;
    color: inherit;
  }
  
  .slide-section ul,
  .slide-section ol {
    margin: 1rem 0;
    padding-left: 2rem;
  }
  
  .slide-section ul {
    list-style-type: disc;
  }
  
  .slide-section ol {
    list-style-type: decimal;
  }
  
  .slide-section li {
    margin: 0.75rem 0;
    padding-left: 0.5rem;
  }
  
  .slide-section pre {
    background: #1e1e1e;
    padding: 1.25rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
    border: 1px solid rgba(14, 165, 233, 0.2);
  }
  
  .dark .slide-section pre {
    background: #0d1117;
    border-color: rgba(14, 165, 233, 0.3);
  }
  
  .slide-section code {
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
  }
  
  .slide-section p code {
    background: rgba(14, 165, 233, 0.15);
    padding: 0.2rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #0EA5E9;
    border: 1px solid rgba(14, 165, 233, 0.2);
  }
  
  .slide-section blockquote {
    border-left: 4px solid #3B82F6;
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    background: rgba(59, 130, 246, 0.1);
    border-radius: 0 0.5rem 0.5rem 0;
    color: inherit;
  }
  
  .dark .slide-section blockquote {
    background: rgba(59, 130, 246, 0.15);
  }
  
  .slide-section hr {
    border: none;
    border-top: 2px solid rgba(14, 165, 233, 0.3);
    margin: 2rem 0;
  }
  
  .slide-section img {
    max-width: 100%;
    border-radius: 0.75rem;
    margin: 1.5rem 0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
  
  .slide-section a {
    color: #3B82F6;
    text-decoration: underline;
    font-weight: 500;
  }
  
  .slide-section a:hover {
    color: #2563EB;
  }
  
  .dark .slide-section a {
    color: #60A5FA;
  }
  
  .dark .slide-section a:hover {
    color: #3B82F6;
  }
</style>

<script>
  // Wait for DOM to be ready
  function init() {
    // Get data from DOM
    var overlay = document.getElementById('slide-mode-overlay');
    var slideHeadings = [];
    var totalSlides = 1;
    
    if (overlay) {
      try {
        slideHeadings = JSON.parse(overlay.dataset.slideHeadings || '[]');
        totalSlides = parseInt(overlay.dataset.totalSlides || '1');
      } catch (e) {
        console.error('Error parsing slide data:', e);
      }
    }
    
    var currentSlide = 0;
    var isDrawing = false;
    var isPointerMode = false;
    var lastX = 0;
    var lastY = 0;
    var drawings = [];
    var currentDrawing = null;
    
    // DOM Elements
    var slideModeToggle = document.getElementById('slide-mode-toggle');
    var slideModeOverlay = document.getElementById('slide-mode-overlay');
    var slideClose = document.getElementById('slide-close');
    var slidePrev = document.getElementById('slide-prev');
    var slideNext = document.getElementById('slide-next');
    var slideContainer = document.getElementById('slide-container');
    var slideContent = document.getElementById('slide-content');
    var slideTitle = document.getElementById('slide-title');
    var slideProgress = document.getElementById('slide-progress');
    var slideDots = document.getElementById('slide-dots');
    var drawingCanvas = document.getElementById('drawing-canvas');
    var drawingModeToggle = document.getElementById('drawing-mode-toggle');
    var clearDrawingsBtn = document.getElementById('clear-drawings');
    var pointerModeToggle = document.getElementById('pointer-mode-toggle');
    
    var ctx = null;
    if (drawingCanvas) {
      ctx = drawingCanvas.getContext('2d');
    }
    
    // Initialize slide mode
    function initSlideMode() {
      if (!slideModeToggle || !slideModeOverlay) return;
      
      slideModeToggle.addEventListener('click', function() {
        console.log('Slide mode toggle clicked');
        toggleSlideMode();
      });
      
      if (slideClose) slideClose.addEventListener('click', toggleSlideMode);
      
      if (slidePrev) {
        slidePrev.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Prev button clicked, current:', currentSlide);
          goToSlide(currentSlide - 1);
        });
      }
      
      if (slideNext) {
        slideNext.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Next button clicked, current:', currentSlide);
          goToSlide(currentSlide + 1);
        });
      }
      
      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboard);
      
      // Drawing functionality
      setupDrawing();
      
      // Drawing mode toggle
      if (drawingModeToggle) drawingModeToggle.addEventListener('click', toggleDrawingMode);
      if (clearDrawingsBtn) clearDrawingsBtn.addEventListener('click', clearDrawings);
      if (pointerModeToggle) pointerModeToggle.addEventListener('click', togglePointerMode);
    }
    
    function toggleSlideMode() {
      var isActive = slideModeOverlay && slideModeOverlay.classList.contains('hidden') === false;
      
      if (isActive) {
        // Exit slide mode
        if (slideModeOverlay) slideModeOverlay.classList.add('hidden');
        document.body.classList.remove('slide-mode-active');
        document.body.classList.remove('presentation-cursor');
        document.body.classList.remove('drawing');
      } else {
        // Enter slide mode
        if (slideModeOverlay) slideModeOverlay.classList.remove('hidden');
        document.body.classList.add('slide-mode-active');
        currentSlide = 0;
        renderSlides();
        renderDots();
        updateSlideInfo();
        resizeCanvas();
      }
    }
    
    function renderSlides() {
      if (!slideContent) return;
      
      var slidesHTML = '';
      
      // Title Slide
      var articleTitle = document.querySelector('h1');
      var articleDescription = document.querySelector('article p');
      var titleText = articleTitle ? articleTitle.textContent : 'Presentation';
      var descText = articleDescription ? articleDescription.textContent : '';
      
      slidesHTML += '<div class="slide active" data-slide="0">' +
        '<div class="slide-content-wrapper text-center" style="display: flex; flex-direction: column; justify-content: center; min-height: 100%;">' +
        '<div class="mb-8">' +
        '<div class="w-24 h-24 mx-auto rounded-2xl bg-gradient-to-r from-primary-500 to-cyan-500 flex items-center justify-center shadow-2xl mb-6">' +
        '<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />' +
        '</svg>' +
        '</div>' +
        '</div>' +
        '<h1 class="text-5xl font-bold mb-6 bg-gradient-to-r from-primary-500 to-cyan-500 bg-clip-text text-transparent">' + escapeHtml(titleText) + '</h1>' +
        '<p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto mb-8">' + escapeHtml(descText) + '</p>' +
        '<div class="flex items-center justify-center gap-3 text-sm text-gray-500">' +
        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />' +
        '</svg>' +
        '<span>Press → or Space to start presentation</span>' +
        '</div>' +
        '</div>' +
        '</div>';
      
      // Content Slides - get content from DOM based on heading slugs
      slideHeadings.forEach(function(heading, index) {
        var element = document.getElementById(heading.slug);
        if (!element) {
          console.log('Element not found for slug:', heading.slug);
          return;
        }
        
        // Get all content until next heading
        var contentHTML = '';
        var sibling = element.nextElementSibling;
        
        while (sibling && !isHeading(sibling)) {
          var clone = sibling.cloneNode(true);
          contentHTML += clone.outerHTML;
          sibling = sibling.nextElementSibling;
        }
        
        slidesHTML += '<div class="slide" data-slide="' + (index + 1) + '">' +
          '<div class="slide-content-wrapper">' +
          '<h2 class="text-3xl font-bold mb-6 pb-4 border-b-2 border-primary-500/30">' + escapeHtml(heading.text) + '</h2>' +
          '<div class="slide-section">' +
          contentHTML +
          '</div>' +
          '</div>' +
          '</div>';
      });
      
      slideContent.innerHTML = slidesHTML;
      console.log('Slides rendered:', slideContent.querySelectorAll('.slide').length, 'slides');
    }
    
    function isHeading(element) {
      return element && (element.tagName === 'H2' || element.tagName === 'H3');
    }
    
    function renderDots() {
      if (!slideDots) return;
      
      var dotsHTML = slideHeadings.map(function(_, index) {
        return '<div class="slide-dot ' + (index === 0 ? 'active' : '') + '" data-slide="' + index + '" title="Slide ' + (index + 1) + '"></div>';
      }).join('');
      
      slideDots.innerHTML = dotsHTML;
      
      // Add click handlers
      slideDots.querySelectorAll('.slide-dot').forEach(function(dot) {
        dot.addEventListener('click', function() {
          var slideIndex = parseInt(dot.getAttribute('data-slide') || '0');
          goToSlide(slideIndex);
        });
      });
    }
    
    function goToSlide(index) {
      if (index < 0 || index >= totalSlides) return;
      
      var slides = slideContent ? slideContent.querySelectorAll('.slide') : [];
      var dots = slideDots ? slideDots.querySelectorAll('.slide-dot') : [];
      
      if (!slides || !dots || slides.length === 0) {
        console.log('No slides found!', slides.length);
        return;
      }
      
      console.log('Going to slide:', index, 'of', totalSlides, 'Total slides DOM:', slides.length);
      
      // Hide current slide
      if (slides[currentSlide]) {
        slides[currentSlide].classList.remove('active');
        console.log('Removed active from slide', currentSlide);
      }
      if (dots[currentSlide]) {
        dots[currentSlide].classList.remove('active');
      }
      
      // Show new slide
      currentSlide = index;
      if (slides[currentSlide]) {
        slides[currentSlide].classList.add('active');
        console.log('Added active to slide', currentSlide);
      }
      if (dots[currentSlide]) {
        dots[currentSlide].classList.add('active');
      }
      
      // Clear drawings for new slide
      clearCanvas();
      loadDrawingsForSlide(currentSlide);
      
      // Scroll to top
      var wrapper = slideContent.querySelector('.slide.active .slide-content-wrapper');
      if (wrapper) wrapper.scrollTop = 0;
      
      updateSlideInfo();
    }
    
    function updateSlideInfo() {
      if (slideProgress) {
        slideProgress.textContent = 'Slide ' + (currentSlide + 1) + ' of ' + totalSlides;
      }
    }
    
    function handleKeyboard(e) {
      // Only handle if slide mode is active
      if (!slideModeOverlay || slideModeOverlay.classList.contains('hidden')) {
        return;
      }
      
      // Ignore if typing in input
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;
      
      console.log('Key pressed:', e.key, 'Current slide:', currentSlide);
      
      switch (e.key) {
        case 'ArrowRight':
        case 'PageDown':
        case ' ':
          e.preventDefault();
          e.stopPropagation();
          console.log('Next triggered by keyboard');
          goToSlide(currentSlide + 1);
          break;
        case 'ArrowLeft':
        case 'PageUp':
          e.preventDefault();
          e.stopPropagation();
          console.log('Prev triggered by keyboard');
          goToSlide(currentSlide - 1);
          break;
        case 'Home':
          e.preventDefault();
          e.stopPropagation();
          goToSlide(0);
          break;
        case 'End':
          e.preventDefault();
          e.stopPropagation();
          goToSlide(totalSlides - 1);
          break;
        case 'd':
        case 'D':
          e.preventDefault();
          toggleDrawingMode();
          break;
        case 'l':
        case 'L':
          e.preventDefault();
          togglePointerMode();
          break;
        case 'c':
        case 'C':
          e.preventDefault();
          if (isDrawing) clearDrawings();
          break;
        case 'Escape':
          e.preventDefault();
          toggleSlideMode();
          break;
        case '?':
          e.preventDefault();
          toggleShortcutsHelp();
          break;
      }
    }
    
    function setupDrawing() {
      if (!drawingCanvas || !ctx) return;
      
      // Set canvas size
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Mouse events
      drawingCanvas.addEventListener('mousedown', startDrawing);
      drawingCanvas.addEventListener('mousemove', draw);
      drawingCanvas.addEventListener('mouseup', stopDrawing);
      drawingCanvas.addEventListener('mouseout', stopDrawing);
      
      // Touch events
      drawingCanvas.addEventListener('touchstart', handleTouchStart);
      drawingCanvas.addEventListener('touchmove', handleTouchMove);
      drawingCanvas.addEventListener('touchend', stopDrawing);
    }
    
    function resizeCanvas() {
      if (!drawingCanvas || !ctx) return;
      drawingCanvas.width = window.innerWidth;
      drawingCanvas.height = window.innerHeight;
    }
    
    function startDrawing(e) {
      if (!isDrawing) return;
      
      lastX = e.offsetX;
      lastY = e.offsetY;
      
      currentDrawing = { paths: [] };
      currentDrawing.paths.push({
        points: [{ x: lastX, y: lastY }],
        color: '#EF4444',
        width: 3
      });
    }
    
    function draw(e) {
      if (!isDrawing || !currentDrawing || !ctx) return;
      
      ctx.strokeStyle = '#EF4444';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      
      currentDrawing.paths[0].points.push({ x: e.offsetX, y: e.offsetY });
      
      lastX = e.offsetX;
      lastY = e.offsetY;
    }
    
    function stopDrawing() {
      if (!isDrawing || !currentDrawing) return;
      
      if (!drawings[currentSlide]) {
        drawings[currentSlide] = { slide: currentSlide, paths: [] };
      }
      drawings[currentSlide].paths.push(...currentDrawing.paths);
      currentDrawing = null;
    }
    
    function handleTouchStart(e) {
      if (!isDrawing || !drawingCanvas) return;
      e.preventDefault();
      var touch = e.touches[0];
      var rect = drawingCanvas.getBoundingClientRect();
      lastX = touch.clientX - rect.left;
      lastY = touch.clientY - rect.top;
      
      currentDrawing = { paths: [] };
      currentDrawing.paths.push({
        points: [{ x: lastX, y: lastY }],
        color: '#EF4444',
        width: 3
      });
    }
    
    function handleTouchMove(e) {
      if (!isDrawing || !currentDrawing || !ctx || !drawingCanvas) return;
      e.preventDefault();
      
      var touch = e.touches[0];
      var rect = drawingCanvas.getBoundingClientRect();
      var x = touch.clientX - rect.left;
      var y = touch.clientY - rect.top;
      
      ctx.strokeStyle = '#EF4444';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(x, y);
      ctx.stroke();
      
      currentDrawing.paths[0].points.push({ x: x, y: y });
      
      lastX = x;
      lastY = y;
    }
    
    function toggleDrawingMode() {
      isDrawing = !isDrawing;
      isPointerMode = false;
      
      if (drawingCanvas) {
        drawingCanvas.classList.toggle('drawing-active', isDrawing);
      }
      
      document.body.classList.toggle('drawing', isDrawing);
      document.body.classList.toggle('presentation-cursor', isDrawing || isPointerMode);
      
      if (drawingModeToggle) {
        drawingModeToggle.classList.toggle('bg-white/30', isDrawing);
      }
      if (pointerModeToggle) {
        pointerModeToggle.classList.remove('bg-white/30');
      }
    }
    
    function togglePointerMode() {
      isPointerMode = !isPointerMode;
      isDrawing = false;
      
      if (drawingCanvas) {
        drawingCanvas.classList.remove('drawing-active');
      }
      
      document.body.classList.toggle('presentation-cursor', isPointerMode);
      document.body.classList.remove('drawing');
      
      if (pointerModeToggle) {
        pointerModeToggle.classList.toggle('bg-white/30', isPointerMode);
      }
      if (drawingModeToggle) {
        drawingModeToggle.classList.remove('bg-white/30');
      }
    }
    
    function clearDrawings() {
      if (!ctx) return;
      
      drawings[currentSlide] = { slide: currentSlide, paths: [] };
      clearCanvas();
    }
    
    function clearCanvas() {
      if (!ctx || !drawingCanvas) return;
      ctx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    }
    
    function loadDrawingsForSlide(slideIndex) {
      if (!ctx || !drawings[slideIndex]) return;
      
      drawings[slideIndex].paths.forEach(function(path) {
        if (path.points.length < 2) return;
        
        ctx.strokeStyle = path.color;
        ctx.lineWidth = path.width;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(path.points[0].x, path.points[0].y);
        
        for (var i = 1; i < path.points.length; i++) {
          ctx.lineTo(path.points[i].x, path.points[i].y);
        }
        
        ctx.stroke();
      });
    }
    
    function toggleShortcutsHelp() {
      var helpEl = document.querySelector('.shortcuts-help');
      
      if (helpEl) {
        helpEl.remove();
        return;
      }
      
      helpEl = document.createElement('div');
      helpEl.className = 'shortcuts-help visible';
      helpEl.innerHTML = '<div class="font-semibold mb-2">Keyboard Shortcuts</div>' +
        '<div>→ / Space : Next slide</div>' +
        '<div>← : Previous slide</div>' +
        '<div>D : Toggle drawing</div>' +
        '<div>L : Toggle pointer</div>' +
        '<div>C : Clear drawings</div>' +
        '<div>Esc : Exit</div>';
      
      document.body.appendChild(helpEl);
      
      setTimeout(function() {
        if (helpEl) {
          helpEl.classList.remove('visible');
          setTimeout(function() { if (helpEl) helpEl.remove(); }, 300);
        }
      }, 5000);
    }
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize on load
    initSlideMode();
  }
  
  // Run after DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>
