---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => {
  return import.meta.env.PROD ? data.draft !== true : true;
});

const posts = allPosts.sort((a, b) => {
  const dateA = a.data.pubDate ? new Date(a.data.pubDate).valueOf() : 0;
  const dateB = b.data.pubDate ? new Date(b.data.pubDate).valueOf() : 0;
  return dateB - dateA;
});

const categories = posts.map(p => p.data.category).filter(Boolean);
const uniqueCategories = categories.filter((cat, index, self) => self.indexOf(cat) === index);

const allTags = posts.flatMap(p => p.data.tags || []);
const uniqueTags = allTags.filter((tag, index, self) => self.indexOf(tag) === index);

function calculateReadTime(body) {
  const text = body.replace(/```[\s\S]*?```/g, '').replace(/`[^`]*`/g, '');
  const words = text.split(/\s+/).length;
  return Math.max(1, Math.ceil(words / 200));
}
---

<Layout title="Blog" description="Articles, tutorials, and insights on cybersecurity, programming, and open-source technologies." currentPage="blog">
  <section class="bg-dark-800/50 border-b border-terminal-border">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
      <div class="max-w-3xl">
        <h1 class="text-4xl sm:text-5xl font-bold text-gray-100 mb-4">
          All <span class="gradient-text">Articles</span>
        </h1>
        <p class="text-xl text-gray-400">
          Deep dives, tutorials, and thoughts on security, development, and technology.
        </p>
      </div>
    </div>
  </section>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <div class="lg:col-span-3">
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
          <div class="relative flex-1">
            <input type="text" id="search-input" placeholder="Search articles..." class="w-full pl-10 pr-4 py-3 bg-dark-800 border border-terminal-border rounded-lg text-gray-100 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500" />
          </div>
          <select id="category-filter" class="px-4 py-3 bg-dark-800 border border-terminal-border rounded-lg text-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500">
            <option value="">All Categories</option>
            {uniqueCategories.map((cat) => {
              const name = cat ? cat.charAt(0).toUpperCase() + cat.slice(1) : 'Article';
              return <option value={cat}>{name}</option>;
            })}
          </select>
        </div>

        <div class="space-y-6" id="articles-grid">
          {posts.map((post) => {
            const readTime = calculateReadTime(post.body);
            const pubDate = new Date(post.data.pubDate);
            const dateStr = pubDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            return (
              <article class="card group overflow-hidden">
                <a href={`/blog/${post.slug}/`} class="block">
                  <div class="p-6">
                    <div class="flex items-center gap-3 mb-4">
                      {post.data.category ? <span class="tag">{post.data.category}</span> : null}
                      <span class="text-sm text-gray-500 font-mono">{dateStr}</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-100 mb-3 group-hover:text-primary-400 transition-colors">{post.data.title}</h2>
                    <p class="text-gray-400 mb-4 line-clamp-2">{post.data.description}</p>
                    <div class="flex items-center justify-between">
                      <div class="flex flex-wrap gap-2">
                        {post.data.tags ? post.data.tags.slice(0, 3).map((tag) => <span class="text-xs text-gray-500 font-mono">#{tag}</span>) : null}
                      </div>
                      <span class="text-sm text-gray-500">{readTime} min read</span>
                    </div>
                  </div>
                </a>
              </article>
            );
          })}
        </div>

        {posts.length === 0 ? (
          <div class="text-center py-20">
            <h3 class="text-xl font-semibold text-gray-100 mb-2">No articles found</h3>
            <p class="text-gray-400">Check back soon for new content!</p>
          </div>
        ) : null}
      </div>

      <aside class="space-y-8">
        <div class="card p-6">
          <h3 class="text-lg font-semibold text-gray-100 mb-4">About the Author</h3>
          <div class="flex items-center gap-4 mb-4">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary-500 to-cyan-400 flex items-center justify-center">
              <span class="text-dark-900 font-bold text-lg">FA</span>
            </div>
            <div>
              <div class="font-semibold text-gray-100">Fajar Adnan</div>
              <div class="text-sm text-gray-500">Security Researcher</div>
            </div>
          </div>
          <p class="text-gray-400 text-sm mb-4">Passionate about cybersecurity, open-source software, and sharing knowledge with the community.</p>
          <a href="/about" class="btn-primary w-full justify-center">Learn More</a>
        </div>

        {uniqueTags.length > 0 ? (
          <div class="card p-6">
            <h3 class="text-lg font-semibold text-gray-100 mb-4">Popular Tags</h3>
            <div class="flex flex-wrap gap-2">
              {uniqueTags.slice(0, 15).map((tag) => <a href={`/blog?tag=${tag}`} class="tag">#{tag}</a>)}
            </div>
          </div>
        ) : null}

        <div class="card p-6">
          <h3 class="text-lg font-semibold text-gray-100 mb-4">Stay Updated</h3>
          <p class="text-gray-400 text-sm mb-4">Subscribe to the RSS feed to never miss an article.</p>
          <a href="/rss.xml" class="btn-secondary w-full justify-center">Subscribe via RSS</a>
        </div>
      </aside>
    </div>
  </div>
</Layout>

<script>
  const searchInput = document.getElementById('search-input');
  const categoryFilter = document.getElementById('category-filter');
  const articlesGrid = document.getElementById('articles-grid');

  function filterArticles() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value;
    const articles = articlesGrid?.querySelectorAll('article');

    articles?.forEach((article) => {
      const title = article.querySelector('h2')?.textContent.toLowerCase() || '';
      const description = article.querySelector('p')?.textContent.toLowerCase() || '';
      const category = article.querySelector('.tag')?.textContent.toLowerCase() || '';

      const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
      const matchesCategory = !selectedCategory || category.includes(selectedCategory);

      if (matchesSearch && matchesCategory) {
        article.removeAttribute('hidden');
      } else {
        article.setAttribute('hidden', '');
      }
    });
  }

  searchInput?.addEventListener('input', filterArticles);
  categoryFilter?.addEventListener('change', filterArticles);
</script>
